# Домашнее задание к занятию "`Резервное копирование баз данных`" - `Алексеев Александр`

### Инструкция по выполнению домашнего задания

   1. Сделайте `fork` данного репозитория к себе в Github и переименуйте его по названию или номеру занятия, например, https://github.com/имя-вашего-репозитория/git-hw или  https://github.com/имя-вашего-репозитория/7-1-ansible-hw).
   2. Выполните клонирование данного репозитория к себе на ПК с помощью команды `git clone`.
   3. Выполните домашнее задание и заполните у себя локально этот файл README.md:
      - впишите вверху название занятия и вашу фамилию и имя
      - в каждом задании добавьте решение в требуемом виде (текст/код/скриншоты/ссылка)
      - для корректного добавления скриншотов воспользуйтесь [инструкцией "Как вставить скриншот в шаблон с решением](https://github.com/netology-code/sys-pattern-homework/blob/main/screen-instruction.md)
      - при оформлении используйте возможности языка разметки md (коротко об этом можно посмотреть в [инструкции  по MarkDown](https://github.com/netology-code/sys-pattern-homework/blob/main/md-instruction.md))
   4. После завершения работы над домашним заданием сделайте коммит (`git commit -m "comment"`) и отправьте его на Github (`git push origin`);
   5. Для проверки домашнего задания преподавателем в личном кабинете прикрепите и отправьте ссылку на решение в виде md-файла в вашем Github.
   6. Любые вопросы по выполнению заданий спрашивайте в чате учебной группы и/или в разделе “Вопросы по заданию” в личном кабинете.
   
Желаем успехов в выполнении домашнего задания!
   
### Дополнительные материалы, которые могут быть полезны для выполнения задания

1. [Руководство по оформлению Markdown файлов](https://gist.github.com/Jekins/2bf2d0638163f1294637#Code)

---

### Задание 1. Резервное копирование
Кейс  
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.  
Необходимо описать, какие варианты резервного копирования подходят в случаях:  
1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.  
1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.  
1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.  
Приведите ответ в свободной форме.  

#### Ответ:  
1.1. Для восстановления в полном объеме за предыдущий день возможны варианты:  
- ежедневное полное резервное копирование в установленное время по окончании рабочего дня (или в технологическое окно с остановкой сервера БД) с хранением в течении нескольких дней;  
- усиленный пот надежности вариант: дополнительно к полному бэкапу за прошедший рабочий день возможно выполнение ежедневного инекрементального копирования за этот же день, что обеспечит бОльшую надежность: в случае, если полный бэкап за прошедший день окажется "битым", то возможно будет провести восстановление из бэкапа предыдущего дня с накатом инкремента за прошедший день.  
* При создании бэкапа необходимо обеспечить проверку его работоспособности путем тестовой попытки восстановления на тестовой базе с запуском "дымовых тестов" и проверкой наличия изменений с датой прошедшего рабочего дня.  
  
  
1.2. Для восстановления данных за час до поломки:  
- подходят инкрементные или дифференциальные резервные копии, выполняемые каждый час. Однако в этом случае необходим тщательный выбор инструмента резервирования и способа получения данных для резервирования - для обеспечения консистентности данных в получаемой копии.  
И также необходим инструментарий подтверждения работоспособности получаемых бэкапов (например, с помощью инструментов CI/CD с pipline jobs, ориентированных на создание копий и их оперативную проверку - см. выше).  
  
  
1.3.* Кейс с моментальным переключением на работающую или починенную базу данных в случае поломки основной - возможен, для этого требуется реализация методов "высокодоступной конфигурации" (High Availability). Для реализации применяются методы репликации данных в режиме реального времени. При сбое основной базы происходит автоматическое переключение на вторую базу "master", или сопряженную базу "slave".  
  
  
### Задание 2. PostgreSQL  
2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).  
2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?  
Приведите ответ в свободной форме.  
  
#### Ответ 2.1.:  Примеры команд резервирования данных и восстановления БД  
Для сервера postgresql существует программа pg_dump, способная обеспечить выгрузку данных из базы данных в различных вариантах (https://www.postgresql.org/docs/9.6/app-pgdump.html).  
Для восстановления применяются программы psql  и pg_restore - в зависимости от формата файлв выгрузки.  
**Важно:** Перед загрузкой дампа необходимо создать базу данных ($ createdb -T template0 newdb).  
Но возможно предварительно удалить существующую БД ($ dropdb books), а при использовании программы pg_restore возможно использование ключей -С -d - тогда данные всегда восстанавливаются в имя базы данных, которое отображается в файле дампа.  
  
Варианты резервирования и восстановления (база, в которую производится восстановление предварительно создана с помощью createdb):  
``` bash
# 1. резервирование в управляющий файл с командами sql
$ pg_dump -U username -W books > db_books_dump
## -U postgres - пользователь БД; ключ и -W будет требовать ввод пароля;
## books - имя БД, db_books_dump - файл с командами sql;

# восстановление:
$ psql -U username -W books_from_file < db_books_dump

# 2. резервирование в архив формата каталога:
$ pg_dump -U postgres -Fd books -f db_books_dump_dir
## -Fd -указывает на формат выгрузки в каталог;
## -f -обязательный параметр при указании имени каталога, в который производится РК;
# восстановление:
$ pg_restore -U postgres -Fd -d books_from_dir db_books_dump_dir
## -Fd -указывает на формат загрузки из каталога;
## -d -параметр указания имени загружаемой БД;

# 3. резервирование в архив в формате tar (совместим с форматом каталога: извлечение архива создает допустимый архив в формате каталога) 
$ pg_dump -U postgres -Ft books > db_books_dump.tar
# восстановление:
$ pg_restore -U postgres -d books_from_tar backup_file.tar
## -d database_name указывает имя базы данных, куда будет восстановлена копия;
## backup_file.tar это файл резервной копии.
```  
#### Ответ 2.1.*: Возможно ли автоматизировать этот процесс? Если да, то как?  
1. Вариант резервирования с помощью cron:  
``` bash
# резервирование выполняется в 02:00 ночи
0 2 * * * pg_dump -U postgres -w -Ft database_name > /backup_dir/backup_file_$(date +\%d-\%m-\%Y).tar
## -w -без ввода пароля; необходимо для служебного пользователя указать пароль в файле .pgpass, или в переменной PGPASSWORD, или иным образом.
```  
  
### Задание 3. MySQL  
3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.  
3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?  
Приведите ответ в свободной форме.  
  
#### Ответ 3.1.: Инкрементное резервное копирование в MySQL  
В MySQL для инкрементного резервного копирования не предусмотрен встроенный инструмент, аналогичный pg_dump.  
Необходимо использование сторонних решений. 
Рассмотрим варианты для MySQL Enterprise Edition и MySQL Community Edition:

1. MySQL Enterprise Edition: содержит инструмент MySQL Enterprise Backup, который поддерживает инкрементное резервное копирование.  
Пример команды для создания инкрементного резервного копирования:  
``` bash
mysqlbackup --user=admin --password=admin_password --backup-dir=/path/to/full/backup/dir --backup-image=/path/to/incremental/backup_image_file_ --with-timestamp backup-to-image
# где:
## --user и --password указывают реквизиты пользователя для доступа к базе данных.
## --backup-dir указывает на директорию, где хранится последнее полное резервное копирование.
## --backup-image указывает путь и имя файла образа для инкрементного резервного копирования.
## --with-timestamp добавляет метку времени к имени директории резервного копирования, что удобно для идентификации и организации резервных копий.
## backup-to-image говорит инструменту создать резервное копирование в виде образа (файла)
```
Для восстановления из инкрементного резервного копирования, сначала требуется восстановить БД из последнего полного резервного копирования.  
А затем применить все инкрементные копии до нужного момента времени.

2. MySQL Community Edition
Здесь могут быить применены бинарные логи MySQL для восстановления базы данных до определенного момента времени. 
При этом бинарное логирование было включено в инстансе MySQL в конфигурационном файле my.cnf:
``` bash
[mysqld]
log_bin=mysql-bin
```  
После чего MySQL будет записывать все изменения в базе данных.  
В результате можено будет выполнить точное восстановление до любого момента времени на основе этих логов.  
Восстановление с использованием бинарных логов включает два шага:  
- Восстановление из последней полной резервной копии.  
- Применение бинарных логов с момента создания этой резервной копии до нужного момента времени.  

Пример команды для применения бинарных логов начиная с определённого файла:
``` bash
mysqlbinlog mysql-bin.000001 mysql-bin.000002 | mysql -u root -p
```
Приведенная команда "проигрывает" изменения, произошедшие после создания последней полной копии.

#### Ответ 3.1.*: В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием? 
- когда требуется моментальное восстановление работосособности БД;
- в случае с MySQL на однои из серверов-репликантов можно настроить фиксацию бинарных логов, что обеспечит высокую степень оперативного резервирования данных;
- когда имеется высокая нагрузка на БД и требуется обеспечить её распределение по инстансам серверов;
- когда требуется минимизировать влияние на работу базы любых дополнительных процессов - включая резервное копирование.